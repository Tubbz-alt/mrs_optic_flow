<launch>

  <arg name="uav_name" default="$(optenv UAV_NAME uav3)"/>

  <group ns="$(arg uav_name)">

    <arg name="gui" default="false"/>
    <arg name="DEBUG" default="false"/>
    <arg name="method" default="4"/>

    <!-- Don't forget to change the camera parameters yaml file -->
    <arg name="FrameSize" default="480"/>
    <arg name="SamplePointSize" default="120"/>
    <arg name="filterMethod" default="allsac"/>
    <arg name="applyAbsBounding" default="true"/>
    <arg name="applyRelBounding" default="false"/>

    <arg name="rotation_correction_enable" default="true"/>
    <arg name="tilt_correction_enable" default="true"/>
    <arg name="ang_rate_source" default="imu"/>
    <arg name="raw_enable" default="false"/>

    <arg name="ScanRadius" default="21"/>
    <arg name="StepSize" default="24"/>
    <arg name="NumberOfBins" default="3"/>

    <arg name="RansacNumOfChosen" default="2"/>
    <arg name="RansacNumOfIter" default="50"/>
    <arg name="RansacThresholdRad" default="1"/>

    <arg name="lastSpeedsSize" default="60"/>
    <arg name="analyseDuration" default="1"/>

    <arg name="scale_rot_enable" default="false"/>
    <arg name="scale_rot_mag" default="49.9"/>
    <arg name="scale_rot_output" default="velocity"/>
    <arg name="d3d_method" default=""/>

    <arg name="ScaleFactor" default="1"/>

    <arg name="storeVideo" default="false"/>
    <arg name="videoFPS" default="35"/>

    <arg name="maxFPS" default="500"/>
    <arg name="videoPath" default="/dev/null"/>

    <!-- Bluefox2  -->
    <arg name="device" default="$(env BLUEFOX)"/>
    <arg name="rate" default="35"/>

    <!-- Camera Settings -->
    <arg name="serial" default="$(arg device)"/>
    <arg name="camera_name" default="bluefox"/>
    <arg name="camera" default="$(arg camera_name)"/>
    <arg name="frame_id" default="$(arg camera)"/>
    <arg name="calib_url" default="file:///home/mrs/git/uav_modules/miscellaneous/camera_info/bluefox_$(arg uav_name).yaml"/>
    <arg name="fps" default="$(arg rate)"/>

    <arg name="idpf" default="0"/>
    <arg name="aec" default="false"/>
    <arg name="expose_us" default="75"/> <!-- zkusit 1000 a 5000 -->
    <arg name="agc" default="true"/>
    <arg name="gain_db" default="0.0"/>
    <arg name="cbm" default="0"/>
    <arg name="ctm" default="1"/>
    <arg name="dcfm" default="0"/>
    <arg name="hdr" default="false"/>
    <arg name="wbp" default="-1"/>
    <arg name="request" default="0"/>
    <arg name="mm" default="0"/>
    <arg name="jpeg_quality" default="90"/>

    <!-- Node Settings -->
    <arg name="output" default="screen"/>
    <arg name="proc" default="false"/>
    <arg name="view" default="false"/>
    <arg name="calib" default="false"/>

    <!-- Node -->
    <node pkg="bluefox2" type="bluefox2_single_node" name="bluefox" output="$(arg output)">
      <param name="identifier" type="string" value="$(arg serial)"/>
      <param name="frame_id" type="string" value="$(arg frame_id)"/>
      <param name="camera_name" type="string" value="$(arg camera_name)"/>
      <param name="calib_url" type="string" value="$(arg calib_url)"/>
      <param name="fps" type="double" value="$(arg fps)"/>
      <param name="idpf" type="int" value="$(arg idpf)"/>
      <param name="aec" type="bool" value="$(arg aec)"/>
      <param name="expose_us" type="int" value="$(arg expose_us)"/>
      <param name="agc" type="bool" value="$(arg agc)"/>
      <param name="gain_db" type="double" value="$(arg gain_db)"/>
      <param name="cbm" type="int" value="$(arg cbm)"/>
      <param name="ctm" type="int" value="$(arg ctm)"/>
      <param name="dcfm" type="int" value="$(arg dcfm)"/>
      <param name="hdr" type="bool" value="$(arg hdr)"/>
      <param name="wbp" type="int" value="$(arg wbp)"/>
      <param name="request" type="int" value="$(arg request)"/>
      <param name="mm" type="int" value="$(arg mm)"/>

      <!-- Params for theora quality, images being compressed into "stream" -->
      <param name="image_raw/compressed/jpeg_quality" type="int" value="$(arg jpeg_quality)"/>
      <param name="image_raw/theora/keyframe_frequency" value="60" />
      <param name="image_raw/theora/target_bitrate" value="50000" />
      <param name="image_raw/theora/quality" value="8" />
      <param name="image_raw/theora/optimize_for" value="0" />
    </node>

    <node name="optic_flow" pkg="optic_flow" type="optic_flow_node" output="screen" >

      <rosparam file="$(find optic_flow)/yaml/physical_constraints.yaml"/>

      <!-- File with camera parameters - loaded when nothing found on Camera info --> 
      <rosparam file="$(find optic_flow)/yaml/bluefox_uav5_as_of_26-4.yaml"/>

      <param name="DEBUG" type="bool" value="$(arg DEBUG)"/>
      <param name="gui" type="bool" value="$(arg gui)"/>

      <param name="FrameSize" type="int" value="$(arg FrameSize)"/>
      <param name="SamplePointSize" type="int" value="$(arg SamplePointSize)"/>
      <param name="ScanRadius" type="int" value="$(arg ScanRadius)"/>
      <param name="StepSize" type="int" value="$(arg StepSize)"/>

      <param name="ScaleFactor" type="int" value="1"/>
      <param name="CameraImageCompressed" type="bool" value="false"/>

      <param name="method" type="int" value="$(arg method)"/>

      <param name="applyAbsBounding" type="bool" value="$(arg applyAbsBounding)"/>
      <param name="applyRelBounding" type="bool" value="$(arg applyRelBounding)"/>

      <param name="rotation_correction_enable" type="bool" value="$(arg rotation_correction_enable)"/>
      <param name="tilt_correction_enable" type="bool" value="$(arg tilt_correction_enable)"/>
      <param name="ang_rate_source" type="string" value="$(arg ang_rate_source)"/>
      <param name="raw_enable" type="bool" value="$(arg raw_enable)"/>

      <param name="scale_rot_enable" type="bool" value="$(arg scale_rot_enable)"/>
      <param name="scale_rot_mag" type="double" value="$(arg scale_rot_mag)"/>
      <param name="scale_rot_output" type="string" value="$(arg scale_rot_output)"/>
      <param name="d3d_method" type="string" value="$(arg d3d_method)"/>

      <param name="NumberOfBins" type="int" value="$(arg NumberOfBins)"/>

      <param name="RansacNumOfChosen" type="int" value="$(arg RansacNumOfChosen)"/>
      <param name="RansacNumOfIter" type="int" value="$(arg RansacNumOfIter)"/>
      <param name="RansacThresholdRad" type="double" value="$(arg RansacThresholdRad)"/>
      <param name="filterMethod" type="string" value="$(arg filterMethod)"/>

      <param name="lastSpeedsSize" type="int" value="$(arg lastSpeedsSize)"/>
      <param name="analyseDuration" type="double" value="$(arg analyseDuration)"/>

      <param name="storeVideo" type="bool" value="$(arg storeVideo)"/>
      <param name="videoFPS" type="int" value="$(arg videoFPS)"/>
      <param name="videoPath" type="string" value="$(arg videoPath)"/>

      <param name="maxFPS" type="double" value="$(arg maxFPS)"/>

      <remap from="odometry" to="mbzirc_odom/new_odom"/>
      <remap from="camera" to="bluefox/image_raw"/>
      <remap from="camera_info" to="bluefox/camera_info"/>
      <remap from="ranger" to="teraranger/range"/>
      <remap from="imu" to="mavros/imu/data_raw"/>

      <remap from="velocity" to="~velocity"/>
      <remap from="velocity_raw" to="~velocity_raw"/>
      <remap from="velocity_stddev" to="~velocity_stddev"/>
      <remap from="max_velocity" to="~max_velocity"/>
      <remap from="tilt_correction" to="~tilt_correction"/>
      <remap from="allsac_chosen" to="~allsac_chosen"/>

    </node>

  </group>
</launch>
